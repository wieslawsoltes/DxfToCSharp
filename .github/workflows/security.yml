name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 6 * * 1'  # Run weekly on Mondays at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_PATH: './DxfToCSharp.sln'

jobs:
  nuget-audit:
    name: NuGet Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: List packages with vulnerabilities
      run: |
        echo "## NuGet Package Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
        echo "Scanning for vulnerable packages..." >> $GITHUB_STEP_SUMMARY
        
        # Check for vulnerable packages
        VULN_OUTPUT=$(dotnet list package --vulnerable --include-transitive 2>&1 || true)
        
        if echo "$VULN_OUTPUT" | grep -q "no vulnerable packages"; then
          echo "âœ… No vulnerable packages found" >> $GITHUB_STEP_SUMMARY
          echo "$VULN_OUTPUT" >> $GITHUB_STEP_SUMMARY
        elif echo "$VULN_OUTPUT" | grep -q "vulnerable"; then
          echo "âš ï¸ Vulnerable packages detected:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$VULN_OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Set output for later steps
          echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸ Vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$VULN_OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
      id: vuln_scan
      
    - name: List deprecated packages
      run: |
        echo "## Deprecated Package Scan" >> $GITHUB_STEP_SUMMARY
        echo "Scanning for deprecated packages..." >> $GITHUB_STEP_SUMMARY
        
        DEPRECATED_OUTPUT=$(dotnet list package --deprecated --include-transitive 2>&1 || true)
        
        if echo "$DEPRECATED_OUTPUT" | grep -q "no deprecated packages"; then
          echo "âœ… No deprecated packages found" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Deprecated packages detected:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$DEPRECATED_OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Check for outdated packages
      run: |
        echo "## Outdated Package Scan" >> $GITHUB_STEP_SUMMARY
        echo "Scanning for outdated packages..." >> $GITHUB_STEP_SUMMARY
        
        OUTDATED_OUTPUT=$(dotnet list package --outdated --include-transitive 2>&1 || true)
        
        if echo "$OUTDATED_OUTPUT" | grep -q "no updates"; then
          echo "âœ… All packages are up to date" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ Outdated packages found:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTDATED_OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Generate security report
      run: |
        mkdir -p security-reports
        
        # Generate detailed vulnerability report
        echo "# Security Audit Report" > security-reports/security-report.md
        echo "Generated on: $(date)" >> security-reports/security-report.md
        echo "" >> security-reports/security-report.md
        
        echo "## Vulnerable Packages" >> security-reports/security-report.md
        dotnet list package --vulnerable --include-transitive >> security-reports/security-report.md 2>&1 || true
        echo "" >> security-reports/security-report.md
        
        echo "## Deprecated Packages" >> security-reports/security-report.md
        dotnet list package --deprecated --include-transitive >> security-reports/security-report.md 2>&1 || true
        echo "" >> security-reports/security-report.md
        
        echo "## Outdated Packages" >> security-reports/security-report.md
        dotnet list package --outdated --include-transitive >> security-reports/security-report.md 2>&1 || true
        
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: security-reports/
        retention-days: 30
        
    - name: Fail on critical vulnerabilities
      if: steps.vuln_scan.outputs.vulnerabilities_found == 'true'
      run: |
        echo "âŒ Critical vulnerabilities found in dependencies!"
        echo "Please review the security report and update vulnerable packages."
        # Uncomment the next line to fail the build on vulnerabilities
        # exit 1
        
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          7.0.x
          ${{ env.DOTNET_VERSION }}
        
    - name: Verify .NET installation
      run: |
        echo "Installed .NET versions:"
        dotnet --list-runtimes
        echo "Installed .NET SDKs:"
        dotnet --list-sdks
        
    - name: Install dotnet-project-licenses
      run: |
        echo "Installing dotnet-project-licenses tool..."
        if dotnet tool install --global dotnet-project-licenses; then
          echo "âœ… Tool installed successfully"
          dotnet tool list --global | grep dotnet-project-licenses
        else
          echo "âŒ Tool installation failed"
          exit 1
        fi
      
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: Generate license report
      run: |
        mkdir -p license-reports
        
        # Generate license information for all projects
        if dotnet-project-licenses --input ${{ env.SOLUTION_PATH }} \
          --output-directory license-reports \
          --export-license-texts \
          --include-transitive; then
          echo "license_report_generated=true" >> $GITHUB_OUTPUT
          echo "âœ… License report generated successfully"
        else
          echo "license_report_generated=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ License report generation failed"
          # Create a basic report file to ensure directory is not empty
          echo "# License Report Generation Failed" > license-reports/error.md
          echo "The dotnet-project-licenses tool failed to generate the license report." >> license-reports/error.md
          echo "Generated on: $(date)" >> license-reports/error.md
        fi
      id: license_gen
          
    - name: Upload license report
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('license-reports/**') != ''
      with:
        name: license-compliance-report
        path: license-reports/
        retention-days: 30
        
    - name: License summary
      run: |
        echo "## License Compliance Report" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.license_gen.outputs.license_report_generated }}" = "true" ]; then
          echo "âœ… License report generated successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ License information available in artifacts" >> $GITHUB_STEP_SUMMARY
          
          # Show summary of found licenses if available
          if [ -f "license-reports/licenses.json" ]; then
            LICENSE_COUNT=$(jq length license-reports/licenses.json 2>/dev/null || echo "unknown")
            echo "ðŸ“Š Found $LICENSE_COUNT package licenses" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âš ï¸ License report generation failed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Check the workflow logs for more details" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ Error report available in artifacts" >> $GITHUB_STEP_SUMMARY
        fi